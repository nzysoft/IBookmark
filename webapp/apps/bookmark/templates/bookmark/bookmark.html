{% extends "bookmark/base.html" %}

{% load i18n %}
{% load humanize %}
{% load bootstrap_tags %}

{% block extra_script %}
    <script src="{{ STATIC_URL }}js/jquery.pagination.js"></script>
    <script src="{{ STATIC_URL }}js/jquery.tmpl.min.js"></script>
    <script src="{{ STATIC_URL }}js/humane.js"></script>
    <script id="bookmark_row" type="text/x-jquery-tmpl">
        <tr>
            <td><a href="${url}" target="_blank">${url}</a></td>
            <td>${title}</td>
            <td>
                {% templatetag openvariable %}each(i, tag) tags{% templatetag closevariable %}
                <a class="tag" href="{% url api_bookmarks %}?tag=${tag.name}"><span
                        class="badge badge-info">${tag.name}</span></a>
                {% templatetag openvariable %}/each{% templatetag closevariable %}
            </td>
            <td><a class="owner" href="{% url api_bookmarks %}?owner_id=${owner.id}">${owner.username}</a></td>
            <td>${create_time.replace("T", " ").substr(0, 19)}</td>
        </tr>
    </script>
    <script type="text/javascript">
        var items_per_page = "10";
        var api_url = "{% url api_bookmarks %}"

        function update_parameter(a, k, v) {
            var re = new RegExp("([?|&])" + k + "=.*?(&|$)", "i"),
                    separator = a.indexOf('?') !== -1 ? "&" : "?";

            if (a.match(re)) return a.replace(re, '$1' + k + "=" + v + '$2');
            else return a + separator + k + "=" + v;
        }

        /*
         * @param {int}page_index New Page index
         * @param {$} jq the container with the pagination links as a $ object
         */
        function init_pagination() {
            api_url = update_parameter(api_url, "items_per_page", 1);
            //alert(api_url);
            $.ajax({
                url:api_url,
                success:function (data) {
                    if (data && data.redirect) {
                        window.location.href = data.redirect;
                    }
                    if (data.total_count > 0) {
                        //alert("1");
                        $("#pagination_div").pagination(data.total_count, {
                            items_per_page:items_per_page,
                            num_display_entries:2,
                            num_edge_entries:2,
                            prev_text:"&larr; Previous",
                            next_text:"Next &rarr;",
                            callback:pagination_callback
                        });
                    } else {
                        $("#bookmarks_table tbody").empty();
                        $("#bookmarks_table tbody").html('<tr><td colspan="5">{% trans "No Data" %}</td></tr>');
                        $("#pagination_div").empty();
                    }
                },
                dataType:"json"
            });
        }

        function pagination_callback(page_index, jq) {
            api_url = update_parameter(api_url, "items_per_page", items_per_page)
            api_url = update_parameter(api_url, "current_page", page_index + 1)
            render_data();
        }

        function render_data() {
            $.ajax({
                url:api_url,
                success:function (bookmarks) {
                    if (bookmarks.data.length > 0) {
                        $("#bookmarks_table tbody tr").remove();
                        $("#bookmarks_table tbody").empty();
                        $("#bookmark_row").tmpl(bookmarks.data).appendTo("#bookmarks_table tbody");
                    } else {
                        $("#bookmarks_table tbody").empty();
                    }
                },
                dataType:"json"
            });
        }

        $(function () {
            // init page data and render to page
            init_pagination();

            // Search by tag
            $("body").delegate("a.tag", "click", function () {
                api_url = $(this).attr("href");
                init_pagination();
                return false;
            });

            // Search by owner
            $("body").delegate("a.owner", "click", function () {
                api_url = $(this).attr("href");
                init_pagination();
                return false;
            });

            // Refrush data
            $("#reload_btn").click(function () {
                api_url = "{% url api_bookmarks %}";
                init_pagination();
            })

            // Change the items_per_page(10, 30, 50)
            $("ul.per_page_number > li").click(function() {
                $("ul.per_page_number > li").removeClass("active");
                $(this).toggleClass("active");
                items_per_page = $(this).attr("id");
                init_pagination();
            });
        });
    </script>
{% endblock %}

{% block body %}
    <p>
        <a id="reload_btn" class="btn btn-success btn-large">{% trans "Reload" %}</a>
    </p>

    <table id="bookmarks_table" class="table table-striped table-bordered datatable">
        <thead>
        <tr>
            <th>{% trans "URL" %}</th>
            <th>{% trans "Title" %}</th>
            <th>{% trans "Tags" %}</th>
            <th>{% trans "Owner" %}</th>
            <th>{% trans "Created time" %}</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div class="row">
        <div id="per_page_number_div" class="pagination span4">
            <ul class="per_page_number">
                <li id="10" class="active"><a href="#">10</a></li>
                <li id="30"><a href="#">30</a></li>
                <li id="50"><a href="#">50</a></li>
            </ul>
        </div>
        <div id="pagination_div" class="pagination pagination-right span6"></div>
    </div>
{% endblock %}

