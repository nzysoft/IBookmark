{% extends "bookmark/base.html" %}

{% load i18n %}
{% load bootstrap_tags %}

{% block head_title %}
    {% trans "Home" %}
{% endblock %}

{% block extra_script %}
    <script src="{{ STATIC_URL }}js/jquery.pagination.js"></script>
    <script src="{{ STATIC_URL }}js/jquery.tmpl.min.js"></script>
    <script src="{{ STATIC_URL }}js/jquery.tagsinput.min.js"></script>
    <script src="{{ STATIC_URL }}js/jquery.loadmask.min.js"></script>
    <script type="text/javascript">
        var uvOptions = {};
        (function () {
            var uv = document.createElement('script');
            uv.type = 'text/javascript';
            uv.async = true;
            uv.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'widget.uservoice.com/pfJgyrQ0QIKHXSITUEaPEA.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(uv, s);
        })();
    </script>
    <script id="bookmark_row" type="text/x-jquery-tmpl">
        <tr>
            <td><a href="${url}" target="_blank">${url}</a></td>
            <td>${title}</td>
            <td>
                {% templatetag openvariable %}each(i, tag) tags{% templatetag closevariable %}
                <a class="tag" href="{% url api_bookmarks %}?tag=${tag.id}"><span
                        class="label label-info" value="${tag.name}">${tag.name}</span></a>
                {% templatetag openvariable %}/each{% templatetag closevariable %}
            </td>
            <td><a class="owner" href="{% url api_bookmarks %}?owner_id=${owner.id}">${owner.username}</a></td>
            <td>${create_time.replace("T", " ").substr(0, 19)}</td>
        </tr>
    </script>
    <script id="tag_row" type="text/x-jquery-tmpl">
        <a class="tag" href="{% url api_bookmarks %}?tag=${id}">
            <span class="label label-info" value="${name}">${name} x ${bookmark_count}</span>
        </a>
    </script>
    <script type="text/javascript">
        var items_per_page = "10";
        var api_url = "{% url api_bookmarks %}"

        function update_parameter(a, k, v) {
            var re = new RegExp("([?|&])" + k + "=.*?(&|$)", "i"),
                    separator = a.indexOf('?') !== -1 ? "&" : "?";

            if (a.match(re)) return a.replace(re, '$1' + k + "=" + v + '$2');
            else return a + separator + k + "=" + v;
        }

        function init_pagination() {
            api_url = update_parameter(api_url, "items_per_page", items_per_page)
            $.ajax({
                url:api_url,
                cache:false,
                success:function (bookmarks) {
                    if (bookmarks && bookmarks.redirect) {
                        window.location.href = bookmarks.redirect;
                    }
                    if (bookmarks.total_count > 0) {
                        $("#bookmarks_table tbody tr").remove();
                        $("#bookmarks_table tbody").empty();
                        $("#bookmark_row").tmpl(bookmarks.data).appendTo("#bookmarks_table tbody");
                        $("#pagination_div").pagination(bookmarks.total_count, {
                            items_per_page:items_per_page,
                            num_display_entries:2,
                            num_edge_entries:2,
                            prev_text:"&larr; Previous",
                            next_text:"Next &rarr;",
                            callback:render_bookmark
                        });
                    } else {
                        $("#bookmarks_table tbody").empty();
                        $("#bookmarks_table tbody").html('<tr><td colspan="5">{% trans "No Data" %}</td></tr>');
                        $("#pagination_div").empty();
                    }
                },
                dataType:"json"
            });
        }

        function render_bookmark(page_index) {
            api_url = update_parameter(api_url, "current_page", page_index + 1)
            $.ajax({
                url:api_url,
                cache:false,
                success:function (bookmarks) {
                    if (bookmarks.data.length > 0) {
                        $("#bookmarks_table tbody tr").remove();
                        $("#bookmarks_table tbody").empty();
                        $("#bookmark_row").tmpl(bookmarks.data).appendTo("#bookmarks_table tbody");
                    } else {
                        $("#bookmarks_table tbody").empty();
                        $("#bookmarks_table tbody").html('<tr><td colspan="5">{% trans "No Data" %}</td></tr>');
                    }
                },
                dataType:"json"
            });
        }

        function render_tag() {
            $.ajax({
                url:"{% url tag %}",
                cache:false,
                success:function (tags) {
                    if (tags.total_count > 0) {
                        $("#top_10_tags").empty();
                        $("#tag_row").tmpl(tags.data).appendTo("#top_10_tags");
                    } else {
                        $("#top_10_tags").empty();
                    }
                },
                dataType:"json"
            });
        }

        // Main function
        $(function () {
            // Add loading
            $("body")
                    .ajaxStart(function () {
                        $(this).mask("{% trans 'Loading...' %}")
                    })
                    .ajaxComplete(function () {
                        $(this).unmask();
                    });

            // init page data and render to page
            init_pagination();

            // init top 10 tags
            render_tag();

            // Search by tag
            $("body").delegate("a.tag", "click", function () {
                api_url = $(this).attr("href");
                $("#data_title").html('{% trans "Bookmarks tagged by" %} ' + $(this).html());
                init_pagination();
                return false;
            });

            // Search by owner
            $("body").delegate("a.owner", "click", function () {
                api_url = $(this).attr("href");
                $("#data_title").html('{% trans "Bookmarks owner by" %} ' + $(this).html());
                init_pagination();
                return false;
            });

            // Change the items_per_page(10, 30, 50)
            $("ul.per_page_number > li").click(function () {
                $("ul.per_page_number > li").removeClass("active");
                $(this).toggleClass("active");
                items_per_page = $(this).attr("id");
                init_pagination();
            });
        });
    </script>
{% endblock %}

{% block body %}
    <h3 id="data_title">
        {% trans "All public bookmarks" %}
    </h3>

    {% comment %}
    <div class="row">
        <div class="span2"><label for="tags_filter"><h3>{% trans "Tag filter" %}</h3></label></div>
        <div class="span8"><input id="tags_filter" type="text"></div>
    </div>
    {% endcomment %}

    <table id="bookmarks_table" class="table table-striped table-bordered datatable">
        <thead>
        <tr>
            <th>{% trans "URL" %}</th>
            <th>{% trans "Title" %}</th>
            <th>{% trans "Tags" %}</th>
            <th>{% trans "Owner" %}</th>
            <th>{% trans "Created time" %}</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div class="row">
        <div id="per_page_number_div" class="pagination span4">
            <ul class="per_page_number">
                <li id="10" class="active"><a href="#">10</a></li>
                <li id="30"><a href="#">30</a></li>
                <li id="50"><a href="#">50</a></li>
            </ul>
        </div>
        <div id="pagination_div" class="pagination pagination-right span6"></div>
    </div>
{% endblock %}

{% block subnav %}
    <div class="alert alert-info">
        <h3>{% trans "Top 10 tags" %}</h3>

        <div id="top_10_tags">

        </div>
        <div></div>
    </div>
{% endblock %}

